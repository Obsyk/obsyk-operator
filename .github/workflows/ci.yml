# Copyright (c) Obsyk. All rights reserved.
# Licensed under the Apache License, Version 2.0.

name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          check-latest: true

      - name: Set up Earthly
        uses: earthly/actions-setup@v1
        with:
          version: v0.8.16
          use-cache: false

      - name: Configure Earthly
        run: |
          mkdir -p ~/.earthly
          cat > ~/.earthly/config.yml << 'EOF'
          global:
            disable_analytics: true
            disable_log_sharing: true
          EOF

      - name: Run CI checks
        run: earthly +ci

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint Helm chart
        run: |
          if [ -d "charts/obsyk-operator" ]; then
            helm lint charts/obsyk-operator
          else
            echo "Helm chart not yet created, skipping lint"
          fi

      - name: Validate Helm template
        run: |
          if [ -d "charts/obsyk-operator" ]; then
            # Validate template renders correctly with required values
            helm template test-release charts/obsyk-operator \
              --set agent.clusterName=ci-test-cluster \
              --kube-version 1.28.0 \
              > /dev/null
            echo "Helm template validation passed"
          fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install kube-linter
        run: |
          curl -L -o kube-linter https://github.com/stackrox/kube-linter/releases/download/v0.6.8/kube-linter-linux
          chmod +x kube-linter
          sudo mv kube-linter /usr/local/bin/

      - name: Run kube-linter on Helm chart
        run: |
          if [ -d "charts/obsyk-operator" ]; then
            # Generate manifests for scanning
            helm template test-release charts/obsyk-operator \
              --set agent.clusterName=ci-test-cluster \
              --output-dir /tmp/manifests

            # Run kube-linter (warn on issues, don't fail yet)
            kube-linter lint /tmp/manifests --config .kube-linter.yaml || true
          fi

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on config issues yet
